// ==UserScript==
// @name         Edit Link Target
// @namespace    http://tampermonkey.net/
// @version      0.4
// @description  æœ€æ–°ç‰ˆå‚ç…§ã®ãƒªãƒ³ã‚¯ã‚«ãƒ¼ãƒ‰â”ãƒ„ãƒ¼ãƒ«ä¸€è¦§è¡¨â”ãƒ„ãƒ¼ãƒ«çºã‚ãƒšãƒ¼ã‚¸ ã®ãƒªãƒ³ã‚¯ãƒã‚§ãƒƒã‚¯ãƒ»ç·¨é›†
// @author       Ameblo User
// @match        https://ameblo.jp/*
// @match        https://blog.ameba.jp/ucs/entry/srventryupdateinput.do?id=12762321136*
// @match        https://blog.ameba.jp/ucs/entry/srventryupdateinput.do?id=12742312677*
// @match        https://blog.ameba.jp/ucs/entry/srventryupdateinput.do?id=12722637005*
// @match        https://blog.ameba.jp/ucs/entry/srventryupdateinput.do?id=12742352151*
// @match        https://blog.ameba.jp/ucs/entry/srventryupdateinput.do?id=12724427128*
// @match        https://blog.ameba.jp/ucs/entry/srventryupdateinput.do?id=12742312732*
// @match        https://blog.ameba.jp/ucs/entry/srventryupdateinput.do?id=12724430769*
// @match        https://blog.ameba.jp/ucs/entry/srventryupdateinput.do?id=12742312787*
// @match        https://blog.ameba.jp/ucs/entry/srventryupdateinput.do?id=12742386229*
// @match        https://blog.ameba.jp/ucs/entry/srventryupdateinput.do?id=12828652236*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=ameblo.jp
// @grant        none
// ==/UserScript==



document.onclick=function(event){
    let elem=document.elementFromPoint(event.clientX, event.clientY);

    if(elem && event.shiftKey){ // æœ€æ–°ç‰ˆå‚ç…§ã®ãƒªãƒ³ã‚¯ã‚«ãƒ¼ãƒ‰ã‚’ã€ŒShift+å·¦Clcikã€ã§é–‹å§‹
        let select_link=elem.closest('.ogpCard_link');
        if(select_link){
            let link_url=select_link.getAttribute('href');
            let link_page_id= // ãƒªãƒ³ã‚¯ä¸€è¦§ãƒšãƒ¼ã‚¸ID
                link_url.substring(link_url.indexOf('/entry-') +7, link_url.indexOf('.html'));
            if(link_page_id=='12762321136' || link_page_id=='12828652236'){
                event.preventDefault();
                event.stopImmediatePropagation();

                let tool_name=link_url.substring(link_url.indexOf('=') + 1); // ãƒ„ãƒ¼ãƒ«å
                let entry=document.querySelector('.js-entryWrapper');
                let test_id; // ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ãŸè¨˜äº‹ã®ID
                if(entry){
                    test_id=entry.getAttribute('data-unique-entry-id'); }

                if(tool_name.length!=0){
                    edit_link(tool_name, test_id); }

                function edit_link(tool_name, test_id){
                    let path=
                        'https://blog.ameba.jp/ucs/entry/srventryupdateinput.do?'+
                        'id='+ link_page_id +'&name='+ tool_name +'&test_id='+ test_id;
                    window.open(path);
                } // edit_link()

            }}}

} // onclick



if(location.hostname=='blog.ameba.jp'){ // ç®¡ç†ãƒ»ç·¨é›†ç”»é¢ãŒæ¡ä»¶

    let query=window.location.search.substring(1).split('&');
    let edit_page;
    let tool_name;
    let test_id;
    if(query.length==3){
        edit_page=query[0].split('=')[1]; // ç·¨é›†ã§é–‹ã„ã¦ã„ã‚‹ãƒªãƒ³ã‚¯ãƒšãƒ¼ã‚¸ã®ID
        tool_name=decodeURIComponent(query[1]).split('=')[1]; // ãƒ„ãƒ¼ãƒ«å
        test_id=query[2].split('=')[1]; } // ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ãŸè¨˜äº‹ã®ID


    let retry=0;
    let interval=setInterval(wait_target, 100);
    function wait_target(){
        retry++;
        if(retry>10){ // ãƒªãƒˆãƒ©ã‚¤åˆ¶é™ 10å› 1sec
            clearInterval(interval); }
        let target=document.getElementById('cke_1_contents'); // ç›£è¦– target
        if(target){
            clearInterval(interval);
            main(); }}


    function main(){
        let editor_iframe=document.querySelector('.cke_wysiwyg_frame');
        if(editor_iframe){
            let iframe_doc=editor_iframe.contentWindow.document;
            if(iframe_doc){

                if(edit_page=='12762321136' || edit_page=='12828652236'){
                    // æœ€æ–°ç‰ˆä¸€è¦§ãƒšãƒ¼ã‚¸ã®ç·¨é›†ç”»é¢ã®å ´åˆ ğŸŸ¦

                    let tool_link=iframe_doc.querySelectorAll('td:first-child a');
                    for(let k=0; k<tool_link.length; k++){
                        if(tool_link[k].textContent==tool_name){

                            tool_link[k].scrollIntoView({block: "center"});
                            tool_link[k].style.boxShadow='-8px 0 0 red';
                            let td_a=tool_link[k].closest('td');
                            td_a.onclick=function(){
                                tool_link[k].removeAttribute('style'); } // ã‚¯ãƒªãƒƒã‚¯ã§èµ¤ãƒãƒ¼ã‚¯ã‚’æ¶ˆã™

                            setTimeout(()=>{
                                update_check(k);
                            }, 400);

                            setTimeout(()=>{
                                details_page(k);
                            }, 800);

                        }}


                    function update_check(k){
                        let tool_id=tool_link[k].getAttribute('href').replace(/[^0-9]/g, '');

                        if(tool_id>test_id){
                            alert(
                                "\nã€” "+ tool_name +" ã€•ã€€æ›´æ–°æ¸ˆ\n\n"+
                                "ã“ã®è¡¨ã®ãƒªãƒ³ã‚¯ã¯ ãƒ†ã‚¹ãƒˆé–‹å§‹ãƒšãƒ¼ã‚¸ã‚ˆã‚Šæ–°ã—ã„IDã§ã™");
                            tool_link[k].removeAttribute('style'); // èµ¤ãƒãƒ¼ã‚¯ã‚’æ¶ˆã™
                        }
                        if(tool_id==test_id){
                            alert(
                                "\nã€” "+ tool_name +" ã€•ã€€æ›´æ–°æ¸ˆ\n\n"+
                                "ã“ã®è¡¨ã®ãƒªãƒ³ã‚¯ã¯ ãƒ†ã‚¹ãƒˆé–‹å§‹ãƒšãƒ¼ã‚¸ã¨åŒã˜IDã§ã™");
                            tool_link[k].removeAttribute('style'); // èµ¤ãƒãƒ¼ã‚¯ã‚’æ¶ˆã™
                        }
                        if(tool_id<test_id){
                            let conf_str=
                                "\nã€” "+ tool_name +" ã€•ã€€æœªæ›´æ–°\n\n"+
                                "ğŸ”´ ã“ã®ãƒªã‚¹ãƒˆè¡¨ã®ãƒªãƒ³ã‚¯ã¯æ›´æ–°ã•ã‚Œã¦ã„ã¾ã›ã‚“\n\n"+
                                "ã€€ ãƒ†ã‚¹ãƒˆé–‹å§‹ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯ã«æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ";
                            let ok=confirm(conf_str);
                            if(ok){
                                let new_link='https://ameblo.jp/personwritep/entry-'+ test_id +'.html';
                                tool_link[k].setAttribute('data-cke-saved-href', new_link);
                                tool_link[k].setAttribute('href', new_link); }
                            tool_link[k].removeAttribute('style'); // èµ¤ãƒãƒ¼ã‚¯ã‚’æ¶ˆã™
                        }}


                    function details_page(k){
                        let tool_link_tr=tool_link[k].closest('tr');
                        let tool_link_sub=tool_link_tr.querySelector('td:nth-child(3) a');
                        if(tool_link_sub){
                            let sub_url=tool_link_sub.getAttribute('href');
                            if(sub_url){
                                let sub_id=
                                    sub_url.substring(sub_url.indexOf('/entry-') +7, sub_url.indexOf('.html'));
                                let sub_path=
                                    'https://blog.ameba.jp/ucs/entry/srventryupdateinput.do?' +
                                    'id='+ sub_id +'&name='+ tool_name +'&test_id='+ test_id;
                                window.open(sub_path); }}}

                } // æœ€æ–°ç‰ˆä¸€è¦§ãƒšãƒ¼ã‚¸ã®ç·¨é›†ç”»é¢ã®å ´åˆ



                else { // ãƒ„ãƒ¼ãƒ«çºã‚ãƒšãƒ¼ã‚¸ã®ç·¨é›†ç”»é¢ã®å ´åˆ ğŸŸ¦

                    let card_title=iframe_doc.querySelectorAll('.ogpCard_title');
                    let count=0;
                    for(let k=0; k<card_title.length; k++){
                        if(card_title[k].textContent.includes(tool_name)){
                            count+=1; }}
                    if(count>1){
                        alert("ğŸ”´ èª¿æŸ»å¯¾è±¡ã®ãƒ„ãƒ¼ãƒ«åã‚’å«ã‚€ã‚«ãƒ¼ãƒ‰ãŒè¤‡æ•°ã‚ã‚Šã¾ã™ ğŸ”´"); }
                    else if(count==0){
                        alert("ğŸ”´ èª¿æŸ»å¯¾è±¡ã®ãƒ„ãƒ¼ãƒ«åã‚’å«ã‚€ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ ğŸ”´"); }


                    let card_link=iframe_doc.querySelectorAll('.ogpCard_link');
                    for(let k=0; k<card_link.length; k++){
                        let title=card_link[k].querySelector('.ogpCard_title');
                        if(title){
                            let title_name=title.textContent;
                            if(title_name.includes(tool_name)){
                                card_link[k].scrollIntoView({block: "center"});

                                setTimeout(()=>{
                                    update_card(card_link[k], title_name);
                                }, 400);
                                break;
                            }}}


                    function update_card(card, title_name){


                        let tool_id=card.getAttribute('href').replace(/[^0-9]/g, '');

                        if(tool_id>test_id){
                            alert(
                                "\n"+ title_name +"\n\nã€€â— æ›´æ–°æ¸ˆ\n\n"+
                                "ã“ã®ãƒªãƒ³ã‚¯ã‚«ãƒ¼ãƒ‰ã¯ ãƒ†ã‚¹ãƒˆé–‹å§‹ãƒšãƒ¼ã‚¸ã‚ˆã‚Šæ–°ã—ã„IDã§ã™"); }
                        if(tool_id==test_id){
                            alert(
                                "\n"+ title_name +"\n\nã€€â— æ›´æ–°æ¸ˆ\n\n"+
                                "ã“ã®ãƒªãƒ³ã‚¯ã‚«ãƒ¼ãƒ‰ã¯ ãƒ†ã‚¹ãƒˆé–‹å§‹ãƒšãƒ¼ã‚¸ã¨åŒã˜IDã§ã™"); }
                        if(tool_id<test_id){
                            let conf_str=
                                "\n"+ title_name +"\n\nã€€â— æœªæ›´æ–°\n\n"+
                                "ğŸ”´ ã“ã®ãƒªãƒ³ã‚¯ã‚«ãƒ¼ãƒ‰ã¯æ›´æ–°ã•ã‚Œã¦ã„ã¾ã›ã‚“\n\n"+
                                "ã€€ ãƒ†ã‚¹ãƒˆé–‹å§‹ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯ã«æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ";
                            let ok=confirm(conf_str);
                            if(ok){
                                let new_link='https://ameblo.jp/personwritep/entry-'+ test_id +'.html';
                                card.setAttribute('data-cke-saved-href', new_link);
                                card.setAttribute('href', new_link); }}}

                } // ãƒ„ãƒ¼ãƒ«çºã‚ãƒšãƒ¼ã‚¸ã®ç·¨é›†ç”»é¢ã®å ´åˆ ğŸŸ¦


            }}} // main()

} // ç®¡ç†ãƒ»ç·¨é›†ç”»é¢ãŒæ¡ä»¶


